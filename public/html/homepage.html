<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moneygotchi</title>
    <link rel="stylesheet" href="/css/homepage.css">
</head>
<body>
    <div class="logout-container">
        <button class="logout-button" aria-label="Logout" id="logout-button">
            <div class="logout-icon"></div>
        </button>
    </div>
    
    <h1>Moneygotchi</h1>
<div class="rectangle">
    <!-- Health bar positioned in upper left corner -->
    <div class="health-container">
        <div class="health-bar health-normal" id="health-bar"></div>
    </div>
    
    <!-- Add emoji container above the pig -->
    <div class="emoji-container" id="emoji-container">ðŸ˜Š</div>
    
    <img src="/images/normal_pig.png" alt="Moneygotchi Pig" class="pet-image" id="pet-image">
</div>
<div class="button-container">
    <button class="button stats-button" aria-label="Stats" id="stats-button">
        <div class="stats-icon">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
    </button>
    <button class="button update-button" aria-label="Interact" id="update-button">
        <div class="update-icon"></div>
    </button>
    <button class="button fortune-button" aria-label="Fortune Teller" id="fortune-button">
        <div class="fortune-icon"></div>
    </button>
</div>
<script>
function checkFinancialHealth() {
    // Get the saved financial data and weekly median spending
    const savedData = JSON.parse(localStorage.getItem('financialData')) || [];
    const weeklyMedianSpending = parseFloat(localStorage.getItem('weeklyMedianSpending') || '0');
    
    // Default status if no data is available
    let status = 'normal';
    let healthPercentage = 50;
    
    // Log the data we're working with for debugging
    console.log("Financial health check:", {
        savedData: savedData,
        weeklyMedianSpending: weeklyMedianSpending
    });
    
    if (savedData.length > 0 && weeklyMedianSpending > 0) {
        const latestData = savedData[savedData.length - 1];
        const annualIncome = parseInt(latestData.annualIncome) || 0;
        const weeklyIncome = annualIncome / 52; // Convert annual income to weekly
        
        // Calculate weekly spending as percentage of weekly income
        const spendingPercentage = (weeklyMedianSpending / weeklyIncome) * 100;
        
        console.log("Weekly financial calculations:", {
            weeklyIncome: weeklyIncome,
            weeklyMedianSpending: weeklyMedianSpending,
            spendingPercentage: spendingPercentage
        });
        
        // Simple status determination based on spending percentage
        if (spendingPercentage > 70) {
            // High spending - over 70% of weekly income
            status = 'bad';
            healthPercentage = Math.max(10, 40 - ((spendingPercentage - 70) / 3)); // decreases with higher spending
        } else if (spendingPercentage > 40) {
            // Medium spending - between 40-70% of weekly income
            status = 'normal';
            healthPercentage = 60;
        } else {
            // Low spending - under 40% of weekly income
            status = 'good';
            healthPercentage = 85;
        }
    }
    
    console.log("Health status determined:", status, healthPercentage);
    
    return {
        status: status,
        healthPercentage: healthPercentage
    };
}

// Function to update the pet image, health bar, and emoji based on financial health
function updatePetStatus() {
    const petImage = document.getElementById('pet-image');
    const healthBar = document.getElementById('health-bar');
    const emojiContainer = document.getElementById('emoji-container');
    const healthStatus = checkFinancialHealth();
    
    // Update health bar percentage and style
    healthBar.style.width = healthStatus.healthPercentage + '%';
    
    // Remove all status classes
    healthBar.classList.remove('health-good', 'health-normal', 'health-bad');
    
    // Add appropriate class based on status and update emoji
    switch(healthStatus.status) {
        case 'good':
            healthBar.classList.add('health-good');
            petImage.src = '/images/rich_pig.png';
            emojiContainer.textContent = 'ðŸ’–'; // Golden heart emoji
            break;
        case 'normal':
            healthBar.classList.add('health-normal');
            petImage.src = '/images/normal_pig.png';
            emojiContainer.textContent = 'ðŸ˜Š'; // Happy face emoji
            break;
        case 'bad':
            healthBar.classList.add('health-bad');
            petImage.src = '/images/hungry_pig.png';
            emojiContainer.textContent = 'ðŸ’€'; // Skull emoji
            break;
    }
}

// Function to show emoji when update button is clicked
function showEmoji() {
    const emojiContainer = document.getElementById('emoji-container');
    emojiContainer.classList.add('show');
    
    // Hide emoji after 3 seconds
    setTimeout(() => {
        emojiContainer.classList.remove('show');
    }, 3000);
}

// Listen for updates from stats page
document.addEventListener('weeklyDataUpdated', function() {
    console.log("Received weekly data update event");
    updatePetStatus();
});

// Add click event listeners to buttons
document.getElementById('stats-button').addEventListener('click', function() {
    window.location.href = '/html/stats.html';
});

document.getElementById('update-button').addEventListener('click', function() {
    // Show emoji animation
    showEmoji();
    
    // Refresh pet status when update button is clicked
    updatePetStatus();
});

document.getElementById('fortune-button').addEventListener('click', function() {
    window.location.href = '/html/FortuneTeller.html';
});

// Add event listener for logout button
document.getElementById('logout-button').addEventListener('click', function() {
    // Clear user session data if needed
    // localStorage.clear(); // Uncomment this if you want to clear all local storage
    
    // Redirect to login page
    window.location.href = '/html/login.html'; // Adjust this to your login page URL
});

// Update pet status when the page loads
document.addEventListener('DOMContentLoaded', function() {
    updatePetStatus();
});

// Also check for updates every minute
setInterval(updatePetStatus, 60000);
</script>
</body>
</html>