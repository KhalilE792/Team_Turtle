<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spending Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="Stats.css">
</head>
<body>
    <!-- Home Button -->
    <div class="home-button-container">
        <a href="index.html" class="home-button">
            <span class="home-icon">âŒ‚</span> Home
        </a>
    </div>

    <div class="container">
        <h1>Spending Tracker</h1>
        <div class="controls">
            <label for="timeSelector">Select Time Period:</label>
            <select id="timeSelector" onchange="updateChart()">
                <option value="week">Week</option>
                <option value="month">Month</option>
                <option value="year">Year</option>
            </select>
        </div>
        <div class="chart-section">
            <div class="chart-container">
                <canvas id="dataChart"></canvas>
            </div>
            <div class="chart-image">
                <img src="stats_pig.png" alt="Spending visualization" class="side-image">
            </div>
        </div>
        <div class="stats-container">
            <div class="stat-item">
                <span class="stat-label">Average Spending:</span>
                <span id="averageSpending" class="stat-value">$0.00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Highest Spending:</span>
                <span id="highestSpending" class="stat-value">$0.00</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Total Spending:</span>
                <span id="totalSpending" class="stat-value">$0.00</span>
            </div>
        </div>
        <div class="info">
            <p>Track your spending patterns over different time periods.</p>
        </div>
    </div>

    <script>
        // Chart configuration
        let chart;
        let data = {};
        
        /**
         * Process MongoDB transaction data into chart format
         * @param {Array} transactions - Array of transaction objects from MongoDB
         * @return {Object} Processed data in the format needed for the chart
         */
        function processTransactionsFromMongoDB(transactions) {
            console.log("Processing MongoDB transactions:", transactions);
            
            const result = {
                day: { labels: ['12AM', '3AM', '6AM', '9AM', '12PM', '3PM', '6PM', '9PM'], values: [0, 0, 0, 0, 0, 0, 0, 0] },
                week: { labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'], values: [0, 0, 0, 0, 0, 0, 0] },
                month: { labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'], values: [0, 0, 0, 0] },
                year: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], values: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] }
            };
            
            let validTransactions = 0;
            let invalidDateCount = 0;
            let zeroAmountCount = 0;
            
            transactions.forEach(transaction => {
                try {
                    // Get date from transaction
                    const date = new Date(transaction.date);
                    
                    // Skip if date is invalid
                    if (isNaN(date.getTime())) {
                        console.warn("Invalid date:", transaction.date);
                        invalidDateCount++;
                        return;
                    }
                    
                    // Get amount from withdrawals field (spending amount)
                    let amount = 0;
                    if (transaction.withdrawals) {
                        // Remove any non-numeric characters except decimal point
                        const cleanAmount = transaction.withdrawals.replace(/[^0-9.]/g, '');
                        amount = parseFloat(cleanAmount) || 0;
                    }
                    
                    // Skip if amount is 0
                    if (amount <= 0) {
                        zeroAmountCount++;
                        return;
                    }
                    
                    validTransactions++;
                    console.log(`Processing transaction: Date=${date.toISOString()}, Amount=${amount}`);
                    
                    // Update daily data (by time of day)
                    const hour = date.getHours();
                    let dayIndex = Math.floor(hour / 3);
                    if (dayIndex >= result.day.values.length) dayIndex = result.day.values.length - 1;
                    result.day.values[dayIndex] += amount;
                    
                    // Update weekly data (by day of week)
                    const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
                    // Adjust to make Monday = 0, Sunday = 6
                    const adjustedDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    result.week.values[adjustedDayOfWeek] += amount;
                    
                    // Update monthly data (by week of month)
                    const dayOfMonth = date.getDate();
                    const weekOfMonth = Math.min(3, Math.floor((dayOfMonth - 1) / 7));
                    result.month.values[weekOfMonth] += amount;
                    
                    // Update yearly data (by month)
                    const month = date.getMonth(); // 0 = January
                    result.year.values[month] += amount;
                } catch (error) {
                    console.error("Error processing transaction:", error, transaction);
                }
            });
            
            console.log(`Processed ${validTransactions} valid transactions`);
            console.log(`Skipped ${invalidDateCount} transactions with invalid dates`);
            console.log(`Skipped ${zeroAmountCount} transactions with zero amounts`);
            console.log("Processed data:", result);
            
            return result;
        }
        
        /**
         * Generate fallback data for a time period if json does not read
         */
        function generateFallbackData() {
            console.log("Generating fallback data");
            return {
                day: {
                    labels: ['12AM', '3AM', '6AM', '9AM', '12PM', '3PM', '6PM', '9PM'],
                    values: [0, 0, 4.99, 12.50, 24.75, 8.99, 35.40, 42.15]
                },
                week: {
                    labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                    values: [45.20, 28.75, 63.40, 52.18, 89.95, 124.50, 37.80]
                },
                month: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    values: [285.65, 342.18, 276.90, 304.25]
                },
                year: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    values: [1245.80, 1138.42, 1352.16, 1287.35, 1425.68, 1532.90, 1628.45, 1594.20, 1375.42, 1289.65, 1485.75, 1832.50]
                }
            };
        }

        // Function to load data from MongoDB via API
        function loadJSONData() {
            console.log("Attempting to fetch transaction data from API...");
            
            // Change this to fetch from your MongoDB API instead of static JSON
            fetch('/transactions')
                .then(response => {
                    console.log("Response status:", response.status);
                    
                    if (!response.ok) {
                        throw new Error('Database response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(transactions => {
                    console.log("Transactions retrieved successfully:", transactions);
                    
                    // Check if we have data
                    if (!transactions || transactions.length === 0) {
                        console.warn("No transactions found in database, using fallback data");
                        data = generateFallbackData();
                    } else {
                        // Process transactions from MongoDB
                        data = processTransactionsFromMongoDB(transactions);
                    }
                    
                    initChart(); // Initialize chart after data is loaded
                })
                .catch(error => {
                    console.error('Error loading from database:', error);
                    // Fallback data if database connection fails
                    data = generateFallbackData();
                    initChart();
                });
        }

        // Calculate statistics for the current time period
        function calculateStats(values) {
            // Calculate average
            const sum = values.reduce((acc, val) => acc + val, 0);
            const average = sum / values.length;
            
            // Calculate highest value
            const highest = Math.max(...values);
            
            // Calculate total
            const total = sum;
            
            return {
                average,
                highest,
                total
            };
        }

        // Update statistics display
        function updateStatsDisplay(stats) {
            document.getElementById('averageSpending').textContent = '$' + stats.average.toFixed(2);
            document.getElementById('highestSpending').textContent = '$' + stats.highest.toFixed(2);
            document.getElementById('totalSpending').textContent = '$' + stats.total.toFixed(2);
        }

        // Initialize chart with enhanced styling and average line
        function initChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            
            // Start with week view instead of day
            const initialPeriod = 'week';
            const initialStats = calculateStats(data[initialPeriod].values);
            updateStatsDisplay(initialStats);
            
            // Create horizontal line annotation plugin
            const averageLinePlugin = {
                id: 'averageLine',
                afterDatasetsDraw(chart, args, options) {
                    const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
                    
                    // Get the average for the current dataset
                    const values = chart.data.datasets[0].data;
                    const average = values.reduce((acc, val) => acc + val, 0) / values.length;
                    
                    const yPos = y.getPixelForValue(average);
                    
                    // Draw line
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(left, yPos);
                    ctx.lineTo(right, yPos);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = 'rgba(255, 99, 132, 0.8)';
                    ctx.setLineDash([6, 6]);
                    ctx.stroke();
                    
                    // Draw label
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'bottom';
                    ctx.fillStyle = 'rgba(255, 99, 132, 1)';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText('Average: $' + average.toFixed(2), right, yPos - 5);
                    ctx.restore();
                }
            };
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data[initialPeriod].labels,
                    datasets: [{
                        label: 'Spending',
                        data: data[initialPeriod].values,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(54, 162, 235, 1)',
                        pointHoverBorderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                },
                                font: {
                                    size: 14,
                                    weight: '500'
                                },
                                padding: 10,
                                color: '#666'
                            },
                            border: {
                                dash: [4, 4]
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                font: {
                                    size: 14,
                                    weight: '500'
                                },
                                padding: 10,
                                color: '#666'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Weekly Spending',
                            font: {
                                size: 20,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            },
                            color: '#333'
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 16,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 14
                            },
                            padding: 15,
                            cornerRadius: 6,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    },
                    layout: {
                        padding: {
                            top: 20,
                            right: 25,
                            bottom: 10,
                            left: 10
                        }
                    }
                },
                plugins: [averageLinePlugin]
            });
        }

        // Update chart based on selected time period
        function updateChart() {
            const timeSelector = document.getElementById('timeSelector');
            const selectedPeriod = timeSelector.value;
            
            // Update chart title based on selection
            let titleText;
            switch(selectedPeriod) {
                case 'day':
                    titleText = 'Daily Spending';
                    break;
                case 'week':
                    titleText = 'Weekly Spending';
                    break;
                case 'month':
                    titleText = 'Monthly Spending';
                    break;
                case 'year':
                    titleText = 'Yearly Spending';
                    break;
            }
            
            chart.options.plugins.title.text = titleText;
            
            // Update chart data
            chart.data.labels = data[selectedPeriod].labels;
            chart.data.datasets[0].data = data[selectedPeriod].values;
            
            // Calculate and update statistics for the selected period
            const stats = calculateStats(data[selectedPeriod].values);
            updateStatsDisplay(stats);
            
            // Update chart
            chart.update();
        }

        // Load data and initialize chart when page loads
        window.onload = function() {
            loadJSONData();
        };
    </script>
</body>
</html>